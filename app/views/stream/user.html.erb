<%= stylesheet_link_tag 'https://noraesae.github.io/perfect-scrollbar/perfect-scrollbar.min.css' %>
<%= stylesheet_link_tag 'stream' %>
<div id="stream_main" class="container">
  <!-- Header -->
  <div class="columns" style="margin-bottom:0px;">
    <div class="column is-8">
      <article class="media">
        <figure class="media-left">
          <p class="image is-64x64">
          <%= image_tag @user.twitter_image_url, alt: @user.name %>
          </p>
        </figure>
        <div class="media-content">
          <div class="content">
            <p>
              <span id="stream_title" style="font-size:18pt;"><%= @user.title || t('content.title.default') %></span>
              <br>
              <span style="font-size:14pt;"><%= @user.name %></span>
              <span class="tag is-dark" style="float:right"><%= category(@user.category) %></span>
            </p>
          </div>
        </div>
      </article>
    </div>
    <!-- Open External Chat Window -->
    <div class="column is-4" style="padding-top:0px;padding-bottom:22px;">
      <a href="/<%= @user.name%>/chat_window" class="button is-info open_chat" style="border-radius:0;" target="_blank">
        <i class="fa fa-external-link fa-1" aria-hidden="true"></i><span style="padding-left:4px;"><%= t('streaming.open_chat_window') %></span>
      </a>
    </div>
  </div>

  <div class="columns">
    <!-- Player -->
    <div class="column is-8" style="padding-top:0px;">
      <% if @user.live? %>
        <%= render partial: 'player', locals: { user: @user } %>
        <h2 class="subtitle" id="total" style="padding-top:8px;"><%= t('streaming.total') %> : <%= @user.total %></h2>
      <% else %>
        <%= image_tag "https://s3-ap-northeast-1.amazonaws.com/live-streaming-service/offline.png", alt: 'offline', style:'width:100%;height:auto;', id: 'live' %>
        <br />
        <p style="padding-top:8px;">
          <span class="subtitle"><strong>閲覧<span id="current_number">0</span>人/合計<%= @total %>人</strong></span>
          <% if user_signed_in? %>
            <% unless current_user == @user %>
              <% if current_user.following?(@user) %>
                <%= button_tag t('user.unfollow'), class: 'button is-danger unfollow', style: 'float:right;' %>
                <%= button_tag t('user.follow'), class: 'button is-success follow', style: 'float:right;display:none;' %>
              <% else %>
                <%= button_tag t('user.follow'), class: 'button is-success follow', style: 'float:right;' %>
                <%= button_tag t('user.unfollow'),  class: 'button is-danger unfollow', style: 'float:right;display:none;' %>
              <% end %>
            <% end %>
          <% end %>
        </p>
      <% end %>
    </div>

    <!-- Chat -->
    <div class="column is-4" id="comment_area" style="padding-top:0px;">
      <%= render partial: 'chat', locals: { chats: @chats } %>
      <% if user_signed_in? %>
        <%= form_tag("/#{@user.name}/chat", remote: true, format: :js) do %>
          <%= text_field_tag 'chat[text]', :text, class: 'input message', placeholder: 'Message - Enter で送信', value: '', autofocus: true, style: 'margin-bottom: 10px;', required: false %>
        <% end %>
        <h2 class="subtitle msg-error" style="display:none;">Message can't be empty.</h2>
      <% else %>
        <%= link_to t('chat.signin'), new_user_session_path, class: 'button is-default', style: 'width: 100%;' %>
      <% end %>
    </div>
  </div>
  <!-- Record -->
  <%= render partial: 'records/all', locals: { records: @user.records.select { |r| r.duration.ceil > 0 } } %>
</div>
<div class="container">

  <!-- Description Tab -->
  <div class="tabs">
    <ul>
      <li class="is-active"><a><%= t('user.description') %></a></li>
    </ul>
  </div>

  <!-- Description Main -->
  <section class="hero is-info">
    <% if current_user == @user %>
      <div class="hero-header" style="margin-bottom: 10px;">
        <a style="display:none;" class="cancel button is-info"><%= t('user.cancel') %></a>
        <a class="editDescription button is-info"><%= t('user.edit_description') %></a>
      </div>
    <% end %>
    <div class="container description">
      <%= @content.gsub(/<h1/, "<h1 class='title'").gsub(/<h2/, "<h2 class='subtitle'").html_safe %>
    </div>
  </section>
</div>


<script src='https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-beta1/jquery.min.js'></script>
<script src='https://s3-ap-northeast-1.amazonaws.com/pushould-static-files/v0.0.2/pushould.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery.perfect-scrollbar/0.6.11/js/perfect-scrollbar.jquery.min.js'></script>
<script>
  $(function() {
    $('#comment_area').height($('#live').height() - 28);
    $('#comments').perfectScrollbar();
    $(window).resize(function() {
      $('#comment_area').height($('#live').height() - 28);
      $('#comments').perfectScrollbar();
    });
    $('.follow').click(function(e) {
      e.preventDefault();
      $.ajax({
        type: 'GET',
        url: "/<%= @user.name %>/follow",
        success: function() {
          $('.follow').hide();
          $('.unfollow').show();
        }
      });
    });
    $('.unfollow').click(function(e) {
      e.preventDefault();
      $.ajax({
        type: 'GET',
        url: "/<%= @user.name %>/unfollow",
        success: function() {
          $('.unfollow').hide();
          $('.follow').show();
        }
      });
    });
    $('.extract_chat').on('click', function(e) {
      e.preventDefault();
      var url = $(this).attr('href');
      var windowName = $(this).attr('id');
      var _height = $(window).height();
      window.open(url, "chat_area", "height=" + _height + ", width=400");
    });
    $('.message').keypress(function(e) {
      if (e.which == 13) {
        var _text = jQuery.trim($('.message').val());
        if (_text.length == 0) {
          $('.message').val('');
          $('.msg-error').show();
          return false;
        }
        $('.msg-error').hide();
        $('#chat > ul').append('<% if user_signed_in? %><li><%= link_to stream_path(name: current_user.name), style: 'color: #fff;', target: '_blank'  do %>' +
          '<div class="columns is-mobile" style="width:100%;">' +
            '<div class="column is-1" style="margin-right: 4px;width:32px;"><span class="icon"><%= image_tag User.find_by(name: current_user.name).twitter_image_url, alt: current_user.name %></span></div>' +
            '<div class="column is-11" style="width:91%;word-wrap:break-word;"><%= current_user.name %>' + '<br />' + $('.message').val() + '</div>' +
          '</div>' +
          '<% end %></li><% end %>');
        $('#chat').animate({ scrollTop: $('#chat').prop('scrollHeight') }, "slow");
        $.ajax({
          type: 'POST',
          url: "/<%= @user.name %>/chat",
          data: {
            chat: {
              text: $('.message').val()
            }
          },
        });
        $('.message').val('');
        return false;
      }
    });
    $('.editTitle').on('click', function() {
      $(this).toggle();
      $('.saveTitle').toggle();
      var _title = jQuery.trim($('.streamTitle').text());
      $('.saveTitle').attr('title', _title);
      $('.streamTitle').html('<form id="titleForm" format="js" accept-charset="UTF-8" data-remote="true" method="post" action="/<%= @user.name %>/update_title"><input type="text" name="user[title]" class="input updateTitle" value="' + _title + '" focus="true" placeholder="Enterで保存" /></form>')
    });
    $('.saveTitle').on('click', function() {
      $(this).toggle();
      $('#titleForm').html('<h1 class="title">' + $(this).attr('title') + '</h1>')
      $('.editTitle').toggle();
    });
    $('.editDescription').on('click', function() {
      $(this).toggle();
      $('.cancel').toggle()
      $('.description').html('<form id="descriptionForm" format="js" accept-charset="UTF-8" data-remote="true" method="post" action="/<%= @user.name %>/update_description"><textarea class="textarea" name="user[description]"><%= escape_javascript(@user.description) %></textarea><input type="submit" value="自己紹介を更新する" class="button is-primary is-inverted" /></form>');
    });
    $('.cancel').on('click', function() {
      $(this).toggle();
      $('.editDescription').toggle()
      $('.description').html('<%= escape_javascript(@content.gsub(/<h1/, "<h1 class=\"title\"").gsub(/<h2/, "<h2 class=\"subtitle\"").html_safe) %>');
    });

    $('#chat').animate({ scrollTop: $('#chat').prop('scrollHeight') }, "slow");
    var pushould = new Pushould({ url: '<%= @url %>', client_token: '<%= @client_token %>' });
    var channel = pushould.subscribe('<%= @channel %>');
    channel.bind('send', function(msg) {
      $('#chat > ul').append(
        '<li><a href="/' + msg.name + '" style="color:#fff;" target="_blank">' +
          '<div class="columns is-mobile" style="width:100%;">' +
            '<div class="column is-1" style="margin-right: 4px;width:32px;"><span class="icon"><img src="' + msg.image + '" alt="' + msg.name + '" /></span></div>' +
            '<div class="column is-11" style="width:91%;word-wrap:break-word;">' + msg.nickname + '<br />' + msg.text + '</div>' +
          '</div>' +
        '</a></li>');
      $('#chat').animate({ scrollTop: $('#chat').prop('scrollHeight') }, "slow");
    });
    channel.bind('current', function(msg) {
      $('#current_number').text(msg.count);
    });
    channel.bind('disconnect', function(msg) {
      $.ajax({
        type: 'POST',
        url: '/<%= @user.name %>/current'
      });
    });
    channel.bind('view', function(msg) {
      $('#total').text(msg.views);
    });
  });
</script>
